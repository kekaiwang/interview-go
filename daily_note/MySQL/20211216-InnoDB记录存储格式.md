# InnoDB 记录存储格式

## InnoDB 简介

InnoDB是一个通用的存储引擎，在高可靠性和高性能之间取得平衡。

## InnoDB 行格式

表的行格式确定其行的物理存储方式，这反过来又会影响查询和 DML 操作的性能。由于单个磁盘页中容纳的行越多，查询和索引查找的工作速度会更快，缓冲池中所需的缓存内存也会减少，写出更新值所需的 I/O 也会减少。

现在有4种不同类型的行格式，分别是 `Compact`、`Redundant`、`Dynamic` 和 `Compressed` 行格式。

## CHAR(M) 列的存储格式

`Compact` 行格式在 `CHAR(M)` 类型的列中存储数据的时候分变长字符集和定长字符集的情况，而在 `Redundant` 行格式中十分干脆，不管该列使用的字符集是啥，只要是使用 `CHAR(M)` 类型，占用的真实数据空间就是该字符集表示一个字符最多需要的字节数和M的乘积。比方说使用 utf8 字符集的 `CHAR(10)` 类型的列占用的真实数据空间始终为30个字节，使用 gbk 字符集的 `CHAR(10)` 类型的列占用的真实数据空间始终为20个字节。
由此可以看出来，使用 `Redundant` 行格式的 `CHAR(M)` 类型的列是不会产生碎片的。

## VARCHAR(M) 最多能存储的数据

我们知道对于 `VARCHAR(M)` 类型的列最多可以占用 65535 个字节。**其中的 M 代表该类型最多存储的字符数量**，如果我们使用 `ascii` 字符集的话，一个字符就代表一个字节。

MySQL 对一条记录占用的最大存储空间是有限制的，除了 BLOB 或者 TEXT 类型的列之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过 65535 个字节。所以 MySQL 服务器建议我们把存储类型改为 TEXT 或者 BLOB 的类型。这个 65535 个字节除了列本身的数据之外，还包括一些其他的数据（storage overhead），比如说我们为了存储一个 `VARCHAR(M)` 类型的列，其实需要占用3部分存储空间：

- 真实数据
- 真实数据占用字节的长度
- NULL 值标识，如果该列有 `NOT NULL` 属性则可以没有这部分存储空间

**如果 `VARCHAR` 类型的列没有 `NOT NULL` 属性，那最多只能存储 65532 个字节的数据，因为真实数据的长度可能占用2个字节，NULL值标识需要占用1个字节**。

**如果 `VARCHAR` 类型的列有 NOT NULL 属性，那最多只能存储 65533 个字节的数据，因为真实数据的长度可能占用2个字节，不需要NULL值标识。**

**如果 `VARCHAR(M)` 类型的列使用的不是 ascii 字符集，那 M 的最大取值取决于该字符集表示一个字符最多需要的字节数**。在列的值允许为 NULL 的情况下，gbk 字符集表示一个字符最多需要2个字节，那在该字符集下，M 的最大取值就是 32766（也就是：65532/2），也就是说最多能存储 32766 个字符；utf8 字符集表示一个字符最多需要3个字节，那在该字符集下，M的最大取值就是 21844，就是说最多能存储 21844（也就是：65532/3）个字符。
