# MySQL 常见问题

[toc]

## 1、索引

### 1. 索引是什么？

**索引（Index）是帮助 MySQL 高效获取数据的数据结构**，是对表中一列或多列的值进行排序的结构。
就比如索引是一本书的目录，可以通过目录快速查找自己想要查询的东西。

### 2. 索引的优缺点

1. **优点**

    - 索引大大减小了服务器需要扫描的数据量，从而大大加快数据的检索速度
    - 索引可以帮助服务器避免排序和临时表
    - 索引可以将随机 IO 变成顺序 IO
    - 索引对于 InnoDB（对索引支持行级锁）非常重要，因为它可以让查询锁更少的元组
    - 关于InnoDB、索引和锁：InnoDB在二级索引上使用共享锁（读锁），但访问主键索引需要排他锁（写锁）
    - 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性
    - 可以加速表和表之间的连接
    - 在使用分组和排序子句进行数据检索时，同样可以显著减少查询中分组和排序的时间
    - 通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能

2. **缺点**

    - 索引虽然提高了查询速度，但是随着数据的增加会增加维护和新建索引的耗时，如对表进行 INSERT、UPDATE 和 DELETE。因为更新表时，MySQL 不仅要保存数据，还要更新保存索引文件
    - 建立索引会占用磁盘物理空间。一般情况这个问题不太严重，但如果你在一个大表上创建了多种组合索引，索引文件会变得非常大
    - 如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果
    - 对于非常小的表，大部分情况下简单的全表扫描更高效

### 3. 索引的创建规则

- **应该创建索引的列**
    1. **在经常需要查询的列上**，可以加快搜索的速度
    2. **在主键的列上**，强制该列的唯一性和组织表中数据的排列结构
    3. **在经常用在连接（JOIN）的列上**，这些列主要是一外键，可以加快连接的速度
    4. **在经常需要根据范围（<，<=，=，>，>=，BETWEEN，IN）进行查询的列上创建索引**，因为索引是有序的，其指定的范围是连续的
    5. **在经常需要排序（order by）的列上创建索引**，因为索引是有序的，这样查询可以利用索引的有序性，不需要再进行排序直接可以返回
- **不应该创建索引的列**
    1. 对于那些在查询中很少使用的列不应该创建索引
    若列很少使用到，因此有索引或者无索引，并不能提高查询速度。相反，由于增加了索引，反而降低了系统的维护速度和增大了空间需求。
    2. 对于那些只有很少数据值或者重复值多的列也不应该增加索引，也就是基数小的列不要建索引
    这些列的取值很少，例如人事表的性别列，在查询的结果中，结果集的数据行占了表中数据行的很大比例，即需要在表中搜索的数据行的比例很大。增加索引，并不能明显加快检索速度。
    3. 对于那些定义为 text, imag e和 bit 数据类型的列不应该增加索引。
    这些列的数据量要么相当大，要么取值很少，定义前缀索引区分度也不高
    4. 对修改频率高的列不要建索引，因为带来的查询效果已经远远低于频繁更新带来的维护索引的消耗

### 4. 索引存储结构

1. **哈希表** 是一种以键 - 值（key-value）存储数据的结构，我们只要输入待查找的值即 key，就可以找到其对应的值即 Value。哈希的思路很简单，把值放在数组里，用一个哈希函数把 key 换算成一个确定的位置，然后 value 放在数组的这个位置。
    ![image](/common-question/mysql/index/2022-01-18-hash.png)

    1. 哈希表这种结构适用于只有等值查询的场景  
    2. 有序数组索引只适用于静态存储引擎，插入数据时必须得挪动后面的数据，成本太高.

2. **二叉搜索树**，每个节点的左儿子小于父节点，父节点又小于右儿子。查找的时间复杂度是 O(log(N))。

3. **“N 叉”树**，N 叉树由于在读写上的性能优点，以及适配磁盘的访问模式，已经被广泛应用在数据库引擎中了。
  以 InnoDB 的一个整数字段索引为例，这个 N 差不多是 1200。这棵树高是 4 的时候，就可以存 1200 的 3 次方个值，这已经 17 亿了。考虑到树根的数据块总是在内存中的，一个 10 亿行的表上一个整数字段的索引，查找一个值最多只需要访问 3 次磁盘。

### 4. 索引分类

1. 从数据结构上区分
    1. **聚簇索引**
    非叶子结点页只包含了主键索引列，叶子页包含了行的全部数据。使用聚簇索引可以减少**回表**。
    2. **非聚簇索引**
2. 从应用功能上分
    1. 主键索引
    2. 唯一索引
    3. 二级索引
    4. 联合索引
    5. 全文索引
