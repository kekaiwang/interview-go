# ETCD

## 1. 学习 ETCD 的意义

随着 Kubernetes 成为容器编排领域霸主，etcd 也越来越火热，越来越多的软件工程师使用 etcd 去解决各类业务场景中遇到的痛点。你知道吗？etcd 的 GitHub star 数已超过 34.2K，它的应用场景相当广泛，*从服务发现到分布式锁，从配置存储到分布式协调等等*。可以说，etcd 已经成为了云原生和分布式系统的存储基石。

## 2. 为什么 Kubernetes 使用 etcd ？

当需要一个协调服务来存储服务配置信息、提供分布式锁等能力。怎么办呢？

1. **可用性角度：高可用**。协调服务作为集群的控制面存储，它保存了各个服务的部署、运行信息。若它故障，可能会导致集群无法变更、服务副本数无法协调。业务服务若此时出现故障，无法创建新的副本，可能会影响用户数据面。
2. **数据一致性角度：提供读取“最新”数据的机制**。既然协调服务必须具备高可用的目标，就必然不能存在单点故障（`single point of failure`），而多节点又引入了新的问题，即多个节点之间的数据一致性如何保障？比如一个集群 3 个节点 A、B、C，从节点A、B 获取服务镜像版本是新的，但节点 C 因为磁盘 I/O 异常导致数据更新缓慢，若控制端通过 C 节点获取数据，那么可能会导致读取到过期数据，服务镜像无法及时更新。

3. **容量角度：低容量、仅存储关键元数据配置**。协调服务保存的仅仅是服务、节点的配置信息（属于控制面配置），而不是与用户相关的数据。所以存储上不需要考虑数据分片，无需过度设计。

4. **功能：增删改查，监听数据变化的机制**。协调服务保存了服务的状态信息，若服务有变更或异常，相比控制端定时去轮询检查一个服务状态，若能快速推送变更事件给控制端，则可提升服务可用性、减少协调服务不必要的性能开销。

5. **运维复杂度：可维护性**。在分布式系统中往往会遇到硬件 Bug、软件 Bug、人为操作错误导致节点宕机，以及新增、替换节点等运维场景，都需要对协调服务成员进行变更。若能提供 API 实现平滑地变更成员节点信息，就可以大大降低运维复杂度，减少运维成本，同时可避免因人工变更不规范可能导致的服务异常。

从高可用性、数据一致性、功能这三个角度来说，ZooKeeper 是满足诉求的。但是有几点不足：

1. 当时的 ZooKeeper 不支持通过 API 安全地变更成员，需要人工修改一个个节点的配置，并重启进程。
2. 其次 ZooKeeper 是用 Java 编写的，部署较繁琐，占用较多的内存资源
3. ZooKeeper RPC 的序列化机制用的是 `Jute`，自己实现的 RPC API。无法使用 `curl` 之类的常用工具与之互动，CoreOS 期望使用比较简单的 `HTTP + JSON`。

## 3. etcd 一个度请求的执行过程

### 基础架构

etcd 各层的功能：

1. **Client 层**：Client 层包括 client v2 和 v3 两个大版本 API 客户端库，*提供了简洁易用的 API，同时支持负载均衡、节点间故障自动转移，可极大降低业务使用 etcd 复杂度*，提升开发效率、服务可用性。
2. **API 网络层**：API 网络层主要包括 client 访问 server 和 server 节点之间的通信协议。一方面，client 访问 etcd server 的 API 分为 v2 和 v3 两个大版本。v2 API 使用HTTP/1.x 协议，v3 API 使用 gRPC 协议。同时 v3 通过 etcd rpc-gateway 组件也支持 HTTP/1.x 协议，便于各种语言的服务调用。另一方面，server 之间通信协议，是指节点间通过 Raft 算法实现数据复制和 Leader 选举等功能时使用的 HTTP 协议。
3. **Raft 算法层**：Raft 算法层实现了 Leader 选举、日志复制、ReadIndex 等核心算法特性，*用于保障 etcd 多个节点间的数据一致性、提升服务可用性*等，是 etcd 的基石和亮点。
4. **功能逻辑层**：etcd 核心特性实现层，如典型的 KVServer 模块、MVCC 模块、Auth 鉴权模块、Lease 租约模块、Compactor 压缩模块等，其中 MVCC 模块主要由treeIndex 模块和 boltdb 模块组成。
5. **存储层**：存储层包含预写日志 (WAL) 模块、快照 (Snapshot) 模块、boltdb 模块。*其中 WAL 可保障 etcd crash 后数据不丢失，boltdb 则保存了集群元数据和用户写入的数据*。
